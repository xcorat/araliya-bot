name: release-layered-binary

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        tier: [minimal, default, full]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Ensure workflow runs on tag
        run: |
          if [ "${GITHUB_REF_TYPE}" != "tag" ]; then
            echo "This workflow must run against a tag (for example: v0.2.6)."
            exit 1
          fi

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Build release binary (tier)
        run: |
          set -euo pipefail
          case "${{ matrix.tier }}" in
            minimal)
              cargo build --release --locked --bin araliya-bot --no-default-features --features minimal
              ;;
            default)
              cargo build --release --locked --bin araliya-bot
              ;;
            full)
              cargo build --release --locked --bin araliya-bot --features full
              ;;
            *)
              echo "Unknown tier: ${{ matrix.tier }}"
              exit 1
              ;;
          esac

      - name: Package layered bundle
        run: |
          set -euo pipefail

          tier="${{ matrix.tier }}"
          version="${GITHUB_REF_NAME}"
          bundle_dir="dist/araliya-bot-${version}-${tier}-x86_64-unknown-linux-gnu"
          archive="${bundle_dir}.tar.gz"

          mkdir -p "${bundle_dir}/bin" "${bundle_dir}/config" "${bundle_dir}/frontend"

          cp target/release/araliya-bot "${bundle_dir}/bin/araliya-bot"
          cp -a config/. "${bundle_dir}/config/"
          cp -a frontend/svui "${bundle_dir}/frontend/svui"

          cp "config/${tier}.toml" "${bundle_dir}/config/cfg.toml"

          tar -C dist -czf "dist/$(basename "${archive}")" "$(basename "${bundle_dir}")"

      - name: Upload tier artifact
        uses: actions/upload-artifact@v4
        with:
          name: tier-${{ matrix.tier }}
          path: dist/araliya-bot-${{ github.ref_name }}-${{ matrix.tier }}-x86_64-unknown-linux-gnu.tar.gz

  publish:
    runs-on: ubuntu-latest
    needs: [release]

    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: dist

      - name: Prepare checksums
        run: |
          set -euo pipefail
          find dist -type f -name '*.tar.gz' -print0 | sort -z | xargs -0 sha256sum > dist/SHA256SUMS

      - name: Publish GitHub Release assets
        uses: softprops/action-gh-release@v2
        with:
          files: |
            dist/**/araliya-bot-*-x86_64-unknown-linux-gnu.tar.gz
            dist/SHA256SUMS
          generate_release_notes: true
