#!/bin/bash
# Development setup script using uv
# Sets up CPU-optimized local development environment

set -e

echo "üöÄ Setting up Araliya Bot LOCAL development environment with uv"
echo "   (CPU-optimized for fast local iteration)"
echo "=" * 60

# Check if uv is installed
if ! command -v uv &> /dev/null; then
    echo "‚ùå uv is not installed. Please install it first:"
    echo "   curl -LsSf https://astral.sh/uv/install.sh | sh"
    exit 1
fi

echo "‚úÖ uv found: $(uv --version)"

# Navigate to project directory
cd "$(dirname "$0")/.."

echo "üñ•Ô∏è  Setting up CPU-optimized environment..."
echo "   ‚Ä¢ faiss-cpu for local development"
echo "   ‚Ä¢ torch CPU-only"
echo "   ‚Ä¢ Lightweight sentence-transformers"

echo "üì¶ Installing Python and creating virtual environment..."
uv sync

echo "üß™ Running CPU-optimized tests to verify setup..."
if uv run python scripts/test_cpu_rag.py; then
    echo "‚úÖ CPU RAG tests passed!"
else
    echo "‚ö†Ô∏è  CPU RAG tests failed - checking dependencies..."
    echo "   This is normal if dependencies aren't fully installed yet"
fi

echo "üìã Note: requirements.txt is optimized for HF Spaces ZeroGPU deployment"
echo "   ‚Ä¢ Local dev uses: faiss-cpu, torch (CPU)"
echo "   ‚Ä¢ HF Spaces uses: faiss-gpu, torch (GPU), accelerate"

echo "üéâ Local development environment setup complete!"
echo ""
echo "Local Development Commands:"
echo "  ‚Ä¢ Run server:     uv run python app/main.py"
echo "  ‚Ä¢ Run CPU tests:  uv run python scripts/test_cpu_rag.py"
echo "  ‚Ä¢ Run API tests:  uv run python scripts/test_api_rag.py"
echo "  ‚Ä¢ Install deps:   uv add <package>"
echo ""
echo "HF Spaces Deployment:"
echo "  ‚Ä¢ Uses requirements.txt (GPU-optimized)"
echo "  ‚Ä¢ @spaces.GPU decorator provides ZeroGPU acceleration"
echo "  ‚Ä¢ Automatic fallback to CPU if GPU unavailable"
